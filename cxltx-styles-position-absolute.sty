


% ==========================================================================================================
% Absolute Textpositioning
% ----------------------------------------------------------------------------------------------------------
% see http://www.tex.ac.uk/ctan/macros/latex/contrib/textpos/textpos.pdf
\ProvidesPackage{cxltx-styles-position-absolute}
\usepackage[absolute,overlay]{textpos}
\usepackage{calc}% http://ctan.org/pkg/calc
\usepackage{fp}% http://ctan.org/pkg/fp
\usepackage{changepage}% http://ctan.org/pkg/changepage

% % Set Horizontal and vertical modules:
% \setlength{\TPHorizModule}{1mm}
% \setlength{\TPVertModule}{1mm}

% set origin for absolutely positioned `textblock`s
% (set to upper left corner of main printing area):
% \textblockorigin{0mm}{0mm}%

\def\PaOddLeftMargin{}
\def\PaEvenLeftMargin{}
\def\PaTopMargin{}

\newcommand{\PaOriginToPaper}{%
  \textblockorigin{0mm}{0mm}%
  }

\newcommand{\PaOriginToOddText}{}
\newcommand{\PaOriginToEvenText}{}


\newcommand{\PaOriginToText}{%
  \FPeval{\PaOddLeftMargin}{(\number\hoffset+\number\oddsidemargin+4736286)/186467}%
  \FPeval{\PaEvenLeftMargin}{(\number\evensidemargin+4736286)/186467}%
  \FPeval{\PaTopMargin}{(\number\headsep+\number\headheight+\number\topmargin+\number\voffset+4736286)/186467}%
% ### TAINT this is wrong on more than one level:
  \renewcommand{\PaOriginToOddText}{\textblockorigin{\PaOddLeftMargin mm}{\PaTopMargin mm}}%
  \renewcommand{\PaOriginToEvenText}{\textblockorigin{\PaEvenLeftMargin mm}{\PaTopMargin mm}}%
  }

\PaOriginToText
\PaOriginToPaper

% Define strut dimensions:
\newdimen\PaStrutHeight
\newdimen\PaStrutWidth
\newdimen\PaStrutDepth
\PaStrutWidth=0mm
\PaStrutHeight=0mm
\PaStrutDepth=0mm

% Define text dimensions:
\newdimen\PaTextWidth

% Remove horizontal and vertical spacing from paragraphs; curiously, we have to use a negative value for
% `\parskip` (see http://http://tex.stackexchange.com/questions/167628):
\newcommand{\PaNoSpacing}{\setlength{\parskip}{-\baselineskip}\setlength{\parindent}{0pt}}

% Determine locally valid strut dimensions:
\newcommand{\PaGauge}[1]{%
  \settoheight{\PaStrutHeight}{#1}%
  \settodepth{\PaStrutDepth}{#1}%
  \FPeval{\PaHeightDepthRatio}{\number\PaStrutHeight/(\number\PaStrutHeight+\number\PaStrutDepth)}%
  }

% Run gauging macro once to set default values:
\newcommand{\PaGaugeSample}{\PaGauge{abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?ยง\$}}%
\PaGaugeSample%

% Define a strut with the desired dimensions:
\newcommand{\PaStrut}{{\color{blue}\vrule height\PaStrutHeight width\PaStrutWidth depth\PaStrutDepth}}

\newcommand{\PaOriginToTextOddOrEven}
  \strictpagecheck%
  \checkoddpage%
  \ifoddpage%
    \PaOriginToOddText%
  \else%
    \PaOriginToEvenText%
  \fi%

\newcommand{\PaLeft}[3]{{%
  \PaOriginToTextOddOrEven%
  \settowidth{\PaTextWidth}{#3{\PaStrut}}
  \begin{textblock*}{\PaTextWidth}[0,\PaHeightDepthRatio](#1,#2)%
    \PaNoSpacing%
    \flushleft% needed although it should be gratuitous
    #3%
    {\PaStrut}%
    \end{textblock*}%
  }}

\newcommand{\PaCenter}[3]{{%
  \PaOriginToTextOddOrEven%
  \settowidth{\PaTextWidth}{{\PaStrut}#3{\PaStrut}}
  \begin{textblock*}{\PaTextWidth}[0.5,\PaHeightDepthRatio](#1,#2)%
    \PaNoSpacing%
    \center%
    {\PaStrut}%
    #3%
    {\PaStrut}%
    \end{textblock*}%
  }}

\newcommand{\PaRight}[3]{{%
  \PaOriginToTextOddOrEven%
  \settowidth{\PaTextWidth}{{\PaStrut}#3}
  \begin{textblock*}{\PaTextWidth}[1,\PaHeightDepthRatio](#1,#2)%
    \PaNoSpacing%
    \flushright% needed although it should be gratuitous
    {\PaStrut}%
    #3%
    \end{textblock*}%
  }}

\newcommand{\PaShow}{%
  \textblockrulecolour{orange}
  \TPboxrulesize=0.2mm%
  \TPshowboxestrue%
  \PaStrutWidth=0.8mm%
  }

% There would appear to be a bug / arcane and as yet undocumented feature in `textpos` which causes boxes to
% vertically shift upon execution of `\TPshowboxesfalse`. We remedy that by *always* 'showing' boxes but
% setting rule width to zero.
\newcommand{\PaHide}{%
  \TPboxrulesize=0mm%
  \TPshowboxestrue%
  \PaStrutWidth=0mm%
  }

\PaHide

